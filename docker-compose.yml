version: '3.8'

services:
  people-counter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: people-counter
    ports:
      - "8000:8000"
    volumes:
      # Persist data directories
      - ./cameras:/app/cameras
      - ./models:/app/models
      - ./config:/app/config
      # Database persistence
      - ./people_counter.db:/app/people_counter.db
    environment:
      - DATABASE_URL=sqlite:///./people_counter.db
      - CUDA_VISIBLE_DEVICES=0
    shm_size: '2gb'
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    networks:
      - people-counter-network

  # Optional: PostgreSQL for production
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: people-counter-db
  #   environment:
  #     - POSTGRES_DB=people_counter
  #     - POSTGRES_USER=admin
  #     - POSTGRES_PASSWORD=changeme
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - people-counter-network
  #   restart: unless-stopped

networks:
  people-counter-network:
    driver: bridge

volumes:
  postgres_data:
